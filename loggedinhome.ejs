<html xmlns="http://www.w3.org/1999/xhtml">
    
    <head> 
        <title>Time Feed -- Home</title>
         <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="date.js"></script>

        <link href="StyleSheet1.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
    <div id="fb-root"></div>
            <script type="text/javascript">
                //in the DIV of region, if given a nodeSpot, insert new node before it otherwise if null just append it to region's childlist
                var displayFBpost = function(region,post,insertionSpot) {
					var e = document.createElement("div");
					e.className = "FacebookPost";
					e.style.display = 'none';
					region.insertBefore(e,insertionSpot);
					var from = post.from.name;
					var html = "<div class=\"fbpostauthor\">"+"<img src=\"https://graph.facebook.com/" + post.from.id  + "/picture\"/>"+post.from.name+"</div>";
                    var msg = post.message;
					if (msg == undefined) {
						msg = post.story;
					}
					switch (post.type) 
					{
					case "question":
						html = html+  "<p>" + "<img src=\"" + post.picture  + "\"/>" + "<p>"+ msg;
						break;
					case "link":
						html = html+  "<p>" + "<img src=\"" + post.picture  + "\"/>" + "<p>"+ msg;
						break;
					case "video":
						html = html + "<p>" + "<img src=\"" + post.picture  + "\"/>" + "<p>"+ msg;
						break;
					case "photo":
						html = html +"<p>" + "<img src=\"" + post.picture  + "\"/>" + "<p>"+ msg;
						break;
					case "status":
						html = html +"<p>" + "<img src=\"" + post.picture  + "\"/>" + "<p>"+ msg;
					}
					e.innerHTML = html +"<hr>";
					return {authorid : post.from.id};
                };
/*Set up function to be called when it's time to load the app. (bulk of work) */
                var loadApp = function (accessToken) {
                    //Make nav bar welcome the user (display the name)
                    FB.api('/me', function (response) {
                        console.log(response.name); //delete for browser-compatibility
                        document.getElementById('facebookname').innerHTML = response.name;
                    });
                    //Load news feed + Display initial news feed items + Retrieve authorIds to query their profile pics and show them in their posts (use a hash for optimization?)
                    //*************************************************
                    var mostRecentTime = null;
					var displayedPostTimes = {};
                    FB.api('/me/home', function(response) {
                        console.log(response);
                        var dispArea = document.getElementById('appwindow');
                        var posts = response.data;
						var authorids = [];
                        var i;
                        console.log(posts)
                        for (i = 0;i<posts.length;i++) {
                            authorids.push(displayFBpost(dispArea,posts[i],null).authorid);
							displayedPostTimes[posts[i].created_time] = 1;
                        }
						$(".FacebookPost").slideDown(2000);
						console.log(authorids);
                        //create and send off a Facebook batch of requests for FB post user pictures
						
                    });
                    //Have a timer and periodically check for newer news feed items
                    //************************************************************
                    setInterval(function() { 
                        console.log("hello again")
                        FB.api('/me/home',function(response) {
                            var posts = response.data;
                            var dispArea = document.getElementById('appwindow');
                            var i;
							var insertionSpot = dispArea.firstChild;
                            console.log("most recent: "+mostRecentTime)
                            console.log(posts)

							for (i=0;i<posts.length;i++) {
								if (displayedPostTimes[posts[i].created_time] == undefined) {
									displayedPostTimes[posts[i].created_time] = 1;
									//var e = document.createElement("div");
									//e.className = "addedPost";
									//dispArea.insertBefore(e,insertionSpot);
									//$(".addedPost:first").hide();
	                                //var msg = posts[i].message;
									//if (msg == undefined) {
									//	msg = posts[i].story;
									//}
                                    //displayFBpost(dispArea,post[i],insertionSpot);
		                            //e.innerHTML = "<b>"+posts[i].from.name +"</b>"+"<p>" + "<img src=\"" + posts[i].picture  + "\"/>" + "<p>"+ msg +"<hr>";
									//$(".addedPost:first").slideDown(1000);
								}
							}
                        });
                    },10000)

                };


/*Facebook API initialization and setup code */
                window.fbAsyncInit = function () {
                    FB.init({
                        appId: '<%= appId %>', // App ID
                        status: true, // check login status
                        cookie: true, // enable cookies to allow the server to access the session
                        xfbml: true
                    });
                    var loadedContent = false;
                    FB.getLoginStatus(function (response) {
                        if (response.status === 'connected') {
                            // the user is logged in and has authenticated your
                            // app, and response.authResponse supplies
                            // the user's ID, a valid access token, a signed
                            // request, and the time the access token 
                            // and signed request each expire
                            var uid = response.authResponse.userID;
                            var accessToken = response.authResponse.accessToken;
                            if(!loadedContent) {
                                loadApp(accessToken);
                            }



                            loadedContent = true;
                            //showLoggedIn();
                        } else {
                            document.getElementById("maincontainer").style.display = "none";
                            window.location = "http://" + window.location.host + "/";
                            //document.getElementById("statusText").innerHTML = "Not Logged In";
                        }
                    });
                    FB.Event.subscribe('auth.statusChange', function (response) {
                        if (response.status !== "connected") {
                            document.getElementById("maincontainer").style.display = "none";
                            window.location = "http://" + window.location.host + "/";
                        } else {
                            var accessToken = response.authResponse.accessToken;
                            if(!loadedContent) {
                                loadApp(accessToken);
                            }




                            loadedContent = true;

                        }
                    });

                };
                (function () {
                    var e = document.createElement('script');
                    e.type = 'text/javascript';
                    e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
                    e.async = true;
                    document.getElementById('fb-root').appendChild(e);
                } ());
/*Finish setting up app, Facebook API */
            </script>
<div id="maincontainer" style="display:inline">
<div class="header" id="loggedinheader">Welcome, <span id="facebookname"></span> | Links | Links <div id="fbbutton"> <fb:login-button autologoutlink='true'></fb:login-button></div></div>
<div id="appwindow"> 
</div>












</div>