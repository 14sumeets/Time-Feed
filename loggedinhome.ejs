<html xmlns="http://www.w3.org/1999/xhtml">
    
    <head> 
        <title>Time Feed -- Home</title>
         <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="date.js"></script>

        <link href="StyleSheet1.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
    <div id="fb-root"></div>
            <script type="text/javascript">
/*Set up function to be called when it's time to load the app. (bulk of work) */
                var loadApp = function (accessToken) {
                    //Make nav bar welcome the user (display the name)
                    FB.api('/me', function (response) {
                        console.log(response.name); //delete for browser-compatibility
                        document.getElementById('facebookname').innerHTML = response.name;
                    });
                    //Load news feed + Display initial news feed items
                    var mostRecentTime = null;
					var displayedPostTimes = {};
                    FB.api('/me/home', function(response) {
                        console.log(response);
                        var dispArea = document.getElementById('appwindow');
                        var posts = response.data;
                        var i;
                        console.log(posts)
                        for (i = 0;i<posts.length;i++) {
                            var e = document.createElement("div");
							var msg = posts[i].message;
							if (msg == undefined) {
								msg = posts[i].story;
							}
                            e.innerHTML = "<b>"+posts[i].from.name +"</b>"+"<p>" + "<img src=\"" + posts[i].picture  + "\"/>" + "<p>"+ msg +"<hr>";
                            dispArea.appendChild(e);
							displayedPostTimes[posts[i].created_time] = 1;
                        }
                        //https://graph.facebook.com/oauth/access_token?client_id=111749342300038&client_secret=3d2b916403af7b306c267ab650c36eac&grant_type=client_credentials
                    });
                    //Have a timer and periodically check for newer news feed items
                    setInterval(function() { 
                        console.log("hello again")
                        FB.api('/me/home',function(response) {
                            var posts = response.data;
                            var dispArea = document.getElementById('appwindow');
                            var i;
							var insertionSpot = dispArea.firstChild;
                            console.log("most recent: "+mostRecentTime)
                            console.log(posts)

							for (i=0;i<posts.length;i++) {
								if (displayedPostTimes[posts[i].created_time] == undefined) {
									displayedPostTimes[posts[i].created_time] = 1;
									var e = document.createElement("div");
									e.className = "addedPost";
									dispArea.insertBefore(e,insertionSpot);
									$(".addedPost:first").hide();
	                                var msg = posts[i].message;
									if (msg == undefined) {
										msg = posts[i].story;
									}
		                            e.innerHTML = "<b>"+posts[i].from.name +"</b>"+"<p>" + "<img src=\"" + posts[i].picture  + "\"/>" + "<p>"+ msg +"<hr>";
									$(".addedPost:first").slideDown(1000);
								}
							}
                        });

                    },10000)

                };


/*Facebook API initialization and setup code */
                window.fbAsyncInit = function () {
                    FB.init({
                        appId: '391087367620804', // App ID
                        status: true, // check login status
                        cookie: true, // enable cookies to allow the server to access the session
                        xfbml: true
                    });
                    var loadedContent = false;
                    FB.getLoginStatus(function (response) {
                        if (response.status === 'connected') {
                            // the user is logged in and has authenticated your
                            // app, and response.authResponse supplies
                            // the user's ID, a valid access token, a signed
                            // request, and the time the access token 
                            // and signed request each expire
                            var uid = response.authResponse.userID;
                            var accessToken = response.authResponse.accessToken;
                            if(!loadedContent) {
                                loadApp(accessToken);
                            }



                            loadedContent = true;
                            //showLoggedIn();
                        } else {
                            document.getElementById("maincontainer").style.display = "none";
                            window.location = "http://" + window.location.host + "/";
                            //document.getElementById("statusText").innerHTML = "Not Logged In";
                        }
                    });
                    FB.Event.subscribe('auth.statusChange', function (response) {
                        if (response.status !== "connected") {
                            document.getElementById("maincontainer").style.display = "none";
                            window.location = "http://" + window.location.host + "/";
                        } else {
                            var accessToken = response.authResponse.accessToken;
                            if(!loadedContent) {
                                loadApp(accessToken);
                            }




                            loadedContent = true;

                        }
                    });

                };
                (function () {
                    var e = document.createElement('script');
                    e.type = 'text/javascript';
                    e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
                    e.async = true;
                    document.getElementById('fb-root').appendChild(e);
                } ());
/*Finish setting up app, Facebook API */
            </script>
<div id="maincontainer" style="display:inline">
<div class="header" id="loggedinheader">Welcome, <span id="facebookname"></span> | Links | Links <div id="fbbutton"> <fb:login-button autologoutlink='true'></fb:login-button></div></div>
<div id="appwindow"> 
</div>












</div>